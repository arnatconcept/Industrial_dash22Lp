{% extends "base.html" %}

{% block title %}Dashboard Principal{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Header mejorado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="display-5 fw-bold text-primary mb-1"> Principal</h1>
      <p class="text-muted">Vista general del sistema de gesti贸n industrial</p>
    </div>
    <span class="badge bg-primary fs-6 p-2">
      <i class="bi bi-person-circle me-1"></i>Bienvenido, {{ user.username }}
    </span>
  </div>

  {% if user.is_authenticated %}
    <!-- KPIs Principales en tiempo real -->
    <div class="row g-3 mb-4" id="main-kpis">
      <!-- Se cargar谩n din谩micamente -->
    </div>

    <!-- Alertas y Notificaciones -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <div class="card border-warning shadow-sm" id="alertas-container">
          <div class="card-header bg-warning bg-opacity-10 py-2">
            <h6 class="mb-0"><i class="bi bi-bell-fill text-warning me-2"></i>Alertas y Notificaciones</h6>
          </div>
          <div class="card-body py-3">
            <div id="alertas-content" class="text-center">
              <div class="spinner-border spinner-border-sm text-warning" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <span class="text-muted ms-2">Cargando alertas...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- M贸dulos principales -->
    <div class="row g-4">
      <!-- Producci贸n -->
      <div class="col-md-4">
        <a href="{% url 'produccion_dashboard' %}" class="card card-module text-decoration-none h-100 border-0 shadow-lg hover-lift">
          <div class="card-body text-center p-4">
            <div class="icon-wrapper bg-primary bg-opacity-10 rounded-circle mx-auto mb-3 p-3">
              <i class="bi bi-gear-fill fs-1 text-primary"></i>
            </div>
            <h4 class="card-title text-dark mb-2">Producci贸n</h4>
            <p class="card-text text-muted small">Gesti贸n de procesos productivos y eficiencia</p>
            <div class="mt-3">
              <span class="badge bg-primary" id="produccion-status">Cargando...</span>
            </div>
          </div>
        </a>
      </div>

      <!-- Mantenimiento -->
      <div class="col-md-4">
        <a href="{% url 'mantenimiento_dashboard' %}" class="card card-module text-decoration-none h-100 border-0 shadow-lg hover-lift">
          <div class="card-body text-center p-4">
            <div class="icon-wrapper bg-success bg-opacity-10 rounded-circle mx-auto mb-3 p-3">
              <i class="bi bi-tools fs-1 text-success"></i>
            </div>
            <h4 class="card-title text-dark mb-2">Mantenimiento</h4>
            <p class="card-text text-muted small">Planificaci贸n y seguimiento preventivo</p>
            <div class="mt-3">
              <span class="badge bg-success" id="mantenimiento-status">Cargando...</span>
            </div>
          </div>
        </a>
      </div>

      <!-- Inventario -->
      <div class="col-md-4">
        <a href="{% url 'inventario_dashboard' %}" class="card card-module text-decoration-none h-100 border-0 shadow-lg hover-lift">
          <div class="card-body text-center p-4">
            <div class="icon-wrapper bg-info bg-opacity-10 rounded-circle mx-auto mb-3 p-3">
              <i class="bi bi-box-seam fs-1 text-info"></i>
            </div>
            <h4 class="card-title text-dark mb-2">Inventario</h4>
            <p class="card-text text-muted small">Control de stock y materiales</p>
            <div class="mt-3">
              <span class="badge bg-info" id="inventario-status">Cargando...</span>
            </div>
          </div>
        </a>
      </div>

      <!-- rdenes de Trabajo -->
      <div class="col-md-4">
        <a href="{% url 'ordenes_dashboard' %}" class="card card-module text-decoration-none h-100 border-0 shadow-lg hover-lift">
          <div class="card-body text-center p-4">
            <div class="icon-wrapper bg-warning bg-opacity-10 rounded-circle mx-auto mb-3 p-3">
              <i class="bi bi-clipboard-check fs-1 text-warning"></i>
            </div>
            <h4 class="card-title text-dark mb-2">rdenes de Trabajo</h4>
            <p class="card-text text-muted small">Gesti贸n de 贸rdenes activas y programadas</p>
            <div class="mt-3">
              <span class="badge bg-warning" id="ordenes-status">Cargando...</span>
            </div>
          </div>
        </a>
      </div>

      <!-- Fallas por Turno -->
      <div class="col-md-4">
        <a href="{% url 'dashboard_fallas' %}" class="card card-module text-decoration-none h-100 border-0 shadow-lg hover-lift">
          <div class="card-body text-center p-4">
            <div class="icon-wrapper bg-danger bg-opacity-10 rounded-circle mx-auto mb-3 p-3">
              <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
            </div>
            <h4 class="card-title text-dark mb-2">Fallas por Turno</h4>
            <p class="card-text text-muted small">Registro y seguimiento de incidencias</p>
            <div class="mt-3">
              <span class="badge bg-danger" id="fallas-status">Cargando...</span>
            </div>
          </div>
        </a>
      </div>

      <!-- Resumen General -->
      <div class="col-md-4">
        <div class="card card-module h-100 border-0 shadow-lg">
          <div class="card-body text-center p-4 d-flex flex-column">
            <div class="icon-wrapper bg-secondary bg-opacity-10 rounded-circle mx-auto mb-3 p-3">
              <i class="bi bi-graph-up fs-1 text-secondary"></i>
            </div>
            <h4 class="card-title text-dark mb-2">Resumen General</h4>
            <div class="flex-grow-1 text-start small" id="resumen-general">
              <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <span class="text-muted ms-2">Cargando datos...</span>
              </div>
            </div>
            <div class="mt-auto">
              <button class="btn btn-outline-primary btn-sm me-2" onclick="actualizarDashboard()">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
              </button>
              <span class="text-muted small" id="last-update"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gr谩ficos r谩pidos -->
    <div class="row mt-5">
      <div class="col-md-6">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-pie-chart text-primary me-2"></i>Estado de rdenes</h6>
          </div>
          <div class="card-body">
            <canvas id="chart-ordenes-rapido" height="200"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-bar-chart text-success me-2"></i>Eficiencia por L铆nea</h6>
          </div>
          <div class="card-body">
            <canvas id="chart-eficiencia" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

  {% else %}
    <!-- Estado no autenticado -->
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card border-warning shadow">
          <div class="card-body text-center p-5">
            <i class="bi bi-shield-lock-fill text-warning fs-1 mb-3"></i>
            <h3 class="card-title text-warning mb-3">Acceso Restringido</h3>
            <p class="card-text text-muted mb-4">
              Para acceder a todas las funcionalidades del sistema de gesti贸n industrial, 
              debes iniciar sesi贸n con tus credenciales.
            </p>
            <a href="{% url 'login' %}" class="btn btn-warning btn-lg">
              <i class="bi bi-box-arrow-in-right me-2"></i> Iniciar Sesi贸n
            </a>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script>
  // Configuraci贸n global
  const API_BASE = "/api";
  let token = localStorage.getItem("access_token");
  let dashboardData = {};
  let chartInstances = {};

  // Funci贸n para obtener datos de la API
  async function fetchAPI(endpoint) {
    try {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      
      if(response.status === 401) { 
        localStorage.clear();
        window.location.href = "/login";
        return null;
      }
      
      if(!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('Error fetching data:', error);
      return null;
    }
  }

  // Cargar todos los datos del dashboard
  async function cargarDashboard() {
    try {
      // Cargar datos en paralelo
      const [
        ordenes, 
        produccion, 
        fallas, 
        inventario
      ] = await Promise.all([
        fetchAPI("/ordenes/"),
        fetchAPI("/produccion-turno/"),
        fetchAPI("/fallas-turno/"),
        fetchAPI("/inventario/")
      ]);

      dashboardData = {
        ordenes: ordenes || [],
        produccion: produccion || [],
        fallas: fallas || [],
        inventario: inventario || []
      };

      // Actualizar la interfaz
      actualizarKPIs();
      actualizarEstadosModulos();
      actualizarAlertas();
      actualizarResumenGeneral();
      renderizarGraficos();
      actualizarTimestamp();

    } catch (error) {
      console.error('Error cargando dashboard:', error);
      mostrarError('Error al cargar los datos del dashboard');
    }
  }

  // Actualizar KPIs principales
  function actualizarKPIs() {
    const container = document.getElementById('main-kpis');
    const data = dashboardData;

    // Calcular m茅tricas
    const ordenesPendientes = data.ordenes.filter(o => 
      ['pendiente', 'asignada', 'en_proceso'].includes(o.estado)
    ).length;

    const ordenesCriticas = data.ordenes.filter(o => 
      o.prioridad === 'critica' && ['pendiente', 'asignada'].includes(o.estado)
    ).length;

    const totalProducido = data.produccion.reduce((sum, p) => sum + (p.cantidad || 0), 0);
    const totalFallas = data.fallas.reduce((sum, f) => sum + (f.cantidad || 0), 0);

    const kpis = [
      {
        title: "rdenes Activas",
        value: ordenesPendientes,
        color: "warning",
        icon: "bi-clipboard-check",
        trend: ordenesPendientes > 10 ? "up" : "down"
      },
      {
        title: "rdenes Cr铆ticas",
        value: ordenesCriticas,
        color: "danger",
        icon: "bi-exclamation-triangle",
        trend: ordenesCriticas > 0 ? "up" : "down"
      },
      {
        title: "Producci贸n Total",
        value: totalProducido.toLocaleString(),
        color: "success",
        icon: "bi-gear",
        trend: "stable"
      },
      {
        title: "Fallas Reportadas",
        value: totalFallas,
        color: "info",
        icon: "bi-bug",
        trend: totalFallas > 5 ? "up" : "down"
      },
      {
        title: "Eficiencia Promedio",
        value: calcularEficienciaPromedio() + "%",
        color: "primary",
        icon: "bi-graph-up",
        trend: calcularEficienciaPromedio() > 85 ? "up" : "down"
      }
    ];

    container.innerHTML = kpis.map(kpi => `
      <div class="col-md-2 col-6">
        <div class="card border-0 shadow-sm h-100 hover-lift">
          <div class="card-body text-center p-3">
            <div class="icon-wrapper bg-${kpi.color} bg-opacity-10 rounded-circle mx-auto mb-2 p-2">
              <i class="${kpi.icon} fs-4 text-${kpi.color}"></i>
            </div>
            <h4 class="mb-1 fw-bold text-${kpi.color}">${kpi.value}</h4>
            <small class="text-muted">${kpi.title}</small>
            <div class="mt-1">
              <i class="bi bi-arrow-${kpi.trend}-${kpi.trend === 'up' ? 'up text-danger' : kpi.trend === 'down' ? 'down text-success' : 'right text-muted'} small"></i>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  // Calcular eficiencia promedio
  function calcularEficienciaPromedio() {
    const produccion = dashboardData.produccion;
    if (!produccion.length) return 0;
    
    const totalEficiencia = produccion.reduce((sum, p) => sum + (p.eficiencia || 0), 0);
    return (totalEficiencia / produccion.length).toFixed(1);
  }

  // Actualizar estados de los m贸dulos
  function actualizarEstadosModulos() {
    const data = dashboardData;

    // Producci贸n
    const eficiencia = calcularEficienciaPromedio();
    document.getElementById('produccion-status').textContent = `${eficiencia}% Eficiencia`;

    // Mantenimiento
    const ordenesMantenimiento = data.ordenes.filter(o => 
      ['preventivo', 'correctivo', 'predictivo'].includes(o.tipo) && 
      ['pendiente', 'asignada'].includes(o.estado)
    ).length;
    document.getElementById('mantenimiento-status').textContent = `${ordenesMantenimiento} Pendientes`;

    // Inventario
    const itemsBajos = data.inventario.filter(i => i.stock_actual < i.stock_minimo).length;
    document.getElementById('inventario-status').textContent = itemsBajos > 0 ? 
      `${itemsBajos} Alertas` : 'Stock OK';

    // rdenes
    const ordenesActivas = data.ordenes.filter(o => 
      ['pendiente', 'asignada', 'en_proceso'].includes(o.estado)
    ).length;
    document.getElementById('ordenes-status').textContent = `${ordenesActivas} Activas`;

    // Fallas
    const fallasHoy = data.fallas.filter(f => {
      const fechaFalla = new Date(f.fecha_reporte);
      const hoy = new Date();
      return fechaFalla.toDateString() === hoy.toDateString();
    }).length;
    document.getElementById('fallas-status').textContent = `${fallasHoy} Hoy`;
  }

  // Actualizar alertas
  function actualizarAlertas() {
    const container = document.getElementById('alertas-content');
    const data = dashboardData;

    const alertas = [];

    // Alertas de 贸rdenes cr铆ticas
    const ordenesCriticas = data.ordenes.filter(o => 
      o.prioridad === 'critica' && ['pendiente', 'asignada'].includes(o.estado)
    );
    if (ordenesCriticas.length > 0) {
      alertas.push({
        tipo: 'critica',
        mensaje: `${ordenesCriticas.length} 贸rdenes con prioridad CRTICA pendientes`,
        icon: 'bi-exclamation-triangle-fill'
      });
    }

    // Alertas de stock bajo
    const stockBajo = data.inventario.filter(i => i.stock_actual < i.stock_minimo).length;
    if (stockBajo > 0) {
      alertas.push({
        tipo: 'advertencia',
        mensaje: `${stockBajo} items con stock bajo`,
        icon: 'bi-box-seam'
      });
    }

    // Alertas de eficiencia baja
    const eficiencia = calcularEficienciaPromedio();
    if (eficiencia < 80) {
      alertas.push({
        tipo: 'advertencia',
        mensaje: `Eficiencia baja: ${eficiencia}%`,
        icon: 'bi-graph-down'
      });
    }

    if (alertas.length === 0) {
      container.innerHTML = `
        <div class="text-success">
          <i class="bi bi-check-circle-fill fs-4"></i>
          <p class="mb-0 mt-2">No hay alertas cr铆ticas</p>
          <small class="text-muted">Todo funciona correctamente</small>
        </div>
      `;
    } else {
      container.innerHTML = alertas.map(alerta => `
        <div class="alert alert-${alerta.tipo === 'critica' ? 'danger' : 'warning'} py-2 mb-2">
          <i class="${alerta.icon} me-2"></i>
          ${alerta.mensaje}
        </div>
      `).join('');
    }
  }

  // Actualizar resumen general
  function actualizarResumenGeneral() {
    const container = document.getElementById('resumen-general');
    const data = dashboardData;

    const resumen = `
      <div class="mb-2">
        <i class="bi bi-check-circle text-success me-2"></i>
        <strong>${data.ordenes.filter(o => o.estado === 'completada').length}</strong> 贸rdenes completadas hoy
      </div>
      <div class="mb-2">
        <i class="bi bi-clock text-warning me-2"></i>
        <strong>${data.ordenes.filter(o => o.estado === 'en_proceso').length}</strong> 贸rdenes en proceso
      </div>
      <div class="mb-2">
        <i class="bi bi-gear text-primary me-2"></i>
        <strong>${data.produccion.length}</strong> l铆neas en producci贸n
      </div>
      <div class="mb-2">
        <i class="bi bi-shield-check text-info me-2"></i>
        Sistema operativo al ${calcularEficienciaPromedio()}%
      </div>
    `;

    container.innerHTML = resumen;
  }

  // Renderizar gr谩ficos
  function renderizarGraficos() {
    renderizarChartOrdenes();
    renderizarChartEficiencia();
  }

  function renderizarChartOrdenes() {
    const ctx = document.getElementById('chart-ordenes-rapido').getContext('2d');
    const data = dashboardData.ordenes;

    const estados = ['pendiente', 'asignada', 'en_proceso', 'completada', 'cancelada'];
    const conteo = estados.map(estado => 
      data.filter(o => o.estado === estado).length
    );

    if (chartInstances['ordenes']) {
      chartInstances['ordenes'].destroy();
    }

    chartInstances['ordenes'] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: estados.map(e => e.charAt(0).toUpperCase() + e.slice(1)),
        datasets: [{
          data: conteo,
          backgroundColor: ['#ffc107', '#0d6efd', '#0dcaf0', '#198754', '#dc3545'],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 12,
              padding: 15
            }
          }
        },
        cutout: '60%'
      }
    });
  }

  function renderizarChartEficiencia() {
    const ctx = document.getElementById('chart-eficiencia').getContext('2d');
    const data = dashboardData.produccion;

    // Agrupar por l铆nea y calcular eficiencia promedio
    const lineas = {};
    data.forEach(p => {
      if (!lineas[p.linea_nombre]) {
        lineas[p.linea_nombre] = [];
      }
      lineas[p.linea_nombre].push(p.eficiencia || 0);
    });

    const labels = Object.keys(lineas);
    const valores = labels.map(linea => {
      const eficiencias = lineas[linea];
      return (eficiencias.reduce((a, b) => a + b, 0) / eficiencias.length).toFixed(1);
    });

    if (chartInstances['eficiencia']) {
      chartInstances['eficiencia'].destroy();
    }

    chartInstances['eficiencia'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Eficiencia %',
          data: valores,
          backgroundColor: '#198754',
          borderColor: '#146c43',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        }
      }
    });
  }

  // Utilidades
  function actualizarTimestamp() {
    const now = new Date();
    document.getElementById('last-update').textContent = 
      `Actualizado: ${now.toLocaleTimeString()}`;
  }

  function actualizarDashboard() {
    cargarDashboard();
  }

  function mostrarError(mensaje) {
    // Puedes implementar un sistema de notificaciones toast aqu铆
    console.error(mensaje);
  }

  // Inicializaci贸n
  document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('main-kpis')) {
      cargarDashboard();
      // Actualizar cada 5 minutos
      setInterval(cargarDashboard, 300000);
    }
  });
</script>

<style>
  .card-module {
    transition: all 0.3s ease;
    border-radius: 15px;
  }
  
  .hover-lift:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
  }
  
  .icon-wrapper {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .card-module:hover .icon-wrapper {
    transform: scale(1.1);
  }
  
  .badge {
    font-size: 0.75em;
  }

  .alert {
    margin-bottom: 0.5rem;
  }
</style>
{% endblock %}